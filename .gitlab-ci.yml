image: registry.gitlab.com/technic93/e2designer:latest

# To run tests with local image use
# gitlab-runner exec docker --docker-pull-policy="if-not-present" --docker-privileged <command>

variables:
    UBUNTU_IMAGE: registry.gitlab.com/technic93/e2designer:latest
    BINTRAY_USER: technic
    BINTRAY_REPO: e2designer
    BINTRAY_URL: https://api.bintray.com/content/technic/e2designer/e2designer

stages:
  - images
  - build
  - deploy

image-ubuntu:
  stage: images
  image: docker:git
  services:
    - docker:dind
  before_script:
    - docker info
    - echo building $UBUNTU_IMAGE ...
  script:
    - cd docker
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker build --pull -t $UBUNTU_IMAGE .
    - docker push $UBUNTU_IMAGE
  when: manual

format:
  stage: build
  before_script:
    - clang-format --version
  script:
    - clang-format -style=file -i
      $(find . -type d -path './Qt-Color-Widgets' -prune -iname '*.hpp' -o -iname '*.cpp')
    - git diff --exit-code

before_script:
  - . /opt/qt${Qt}/bin/qt${Qt}-env.sh
  - which qmake
  - qmake --version
  - g++ --version
  - mkdir -p ccache
  - export CCACHE_BASEDIR=${PWD}
  - export CCACHE_DIR=${PWD}/ccache
  - ccache -sz
  - export VERSION=$(git describe)
  - cat /proc/cpuinfo

build:
  stage: build
  script:
    - mkdir -p build
    - pushd build
    - qmake .. "QMAKE_CXX = ccache g++"
    - scan-build -o report make
    - ccache -s
    - make -C app INSTALL_ROOT=$(pwd)/appdir install
    - find appdir
    - curl -fsSL -o linuxdeployqt https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
    - chmod a+x linuxdeployqt
    - curl -fsSL -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
    - chmod a+x appimagetool
    - ./linuxdeployqt appdir/usr/share/applications/e2designer.desktop -bundle-non-qt-libs
      -extra-plugins=iconengines,imageformats
    - ./appimagetool -n --bintray-user $BINTRAY_USER --bintray-repo $BINTRAY_REPO -v appdir
  artifacts:
    paths:
      - build/*.AppImage
      - build/*.AppImage.zsync
      - build/report/
  cache:
    paths:
      - ccache/

clazy:
  stage: build
  script:
    - curl -o /usr/local/bin/clazy http://downloads.kdab.com/clazy/1.5/Clazy-x86_64-1.5.AppImage
    - chmod a+x /usr/local/bin/clazy
    - mkdir -p build && cd build
    - qmake .. "QMAKE_CXX = clazy" "QMAKE_CXXFLAGS += -Werror -fcolor-diagnostics"
    - make
  allow_failure: true

clang-tidy:
  stage: build
  script:
    - lcov --version
    - gcov --version
    - mkdir -p build && cd build
    - qmake -spec linux-clang .. "QMAKE_CXXFLAGS += -fcolor-diagnostics"
    - bear make
    - run-clang-tidy.py

test:
  stage: build
  script:
  - mkdir -p build && cd build
  - qmake .. "QMAKE_CXX = ccache g++"
  - make
  - make check
  cache:
    paths:
      - ccache/

test-cov:
    stage: build
    script:
    - mkdir -p build && cd build
    - qmake .. "CONFIG += debug" "QMAKE_CXXFLAGS += -fprofile-arcs -ftest-coverage" "QMAKE_LFLAGS += --coverage"
    - make
    - make check
    - lcov --directory . --capture --output-file coverage.info
    - lcov --list coverage.info
    - genhtml coverage.info --output-directory coverage-report
    coverage: '/Total:\|(\d+\.?\d+\%)/'
    artifacts:
      paths:
        - build/coverage-report/

deploy-AppImage:
  stage: deploy
  script:
    - curl -T build/e2designer-$VERSION-x86_64.AppImage -u technic:$BINTRAY_API_KEY
      $BINTRAY_URL/$VERSION/e2designer-$VERSION-x86_64.AppImage
    - curl -T build/e2designer-$VERSION-x86_64.AppImage.zsync -u technic:$BINTRAY_API_KEY
      $BINTRAY_URL/$VERSION/e2designer-$VERSION-x86_64.AppImage.zsync
